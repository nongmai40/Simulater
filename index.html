<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Center KPH ü©∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .main-header {
            background: linear-gradient(to right, #8A2BE2, #4A90E2); /* Purple to Blue gradient */
        }
        .nav-button {
            background-color: #DB2777; /* Pink */
            color: white;
            transition: background-color 0.3s ease;
        }
        .nav-button:hover {
            background-color: #BE185D; /* Darker Pink */
        }
        .nav-button.active {
            background-color: #A78BFA; /* Light Purple */
            color: white;
            font-weight: bold;
        }
        /* Style for admin sub-navigation */
        .admin-nav-button {
            background-color: #6D28D9; /* Deeper Purple */
            color: white;
            transition: background-color 0.3s ease;
        }
        .admin-nav-button:hover {
            background-color: #5B21B6; /* Darker Deep Purple */
        }
        .admin-nav-button.active {
            background-color: #EC4899; /* Bright Pink for active admin sub-nav */
            color: white;
            font-weight: bold;
        }

        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block; 
            min-width: 110px; 
            text-align: center;
        }
        .status-available { background-color: #34D399; color: white; } /* Green */
        .status-reserved { background-color: #FBBF24; color: white; } /* Yellow for mannequin '‡∏à‡∏≠‡∏á' */
        .status-borrowed { background-color: #F87171; color: white; } /* Red for mannequin '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°' or reservation '‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡πâ‡∏ß' */
        .status-returned { background-color: #60A5FA; color: white; } /* Blue for reservation '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' */
        .status-cancelled { background-color: #9CA3AF; color: white; } /* Gray for cancelled */
        .status-pending { background-color: #F59E0B; color: white; } /* Amber for reservation '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' */
        .status-approved { background-color: #84CC16; color: white; } /* Lime for reservation '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' */
        .status-maintenance { background-color: #7C3AED; color: white; } /* Violet for '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' */


        .modal {
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }
        .form-input, input[type="file"] { 
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            padding: 0.75rem;
            width: 100%;
        }
        input[type="file"] {
            padding: 0.5rem; 
        }
        .form-input:focus, input[type="file"]:focus {
            outline: none;
            border-color: #8A2BE2; 
            box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.2);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn-sm {
             padding: 0.5rem 1rem;
             font-size: 0.875rem;
        }
        .btn-primary { background-color: #8A2BE2; color: white; } 
        .btn-primary:hover { background-color: #7A1FB5; }
        .btn-secondary { background-color: #DB2777; color: white; } 
        .btn-secondary:hover { background-color: #BE185D; }
        .btn-danger { background-color: #EF4444; color: white; } 
        .btn-danger:hover { background-color: #DC2626; }
        .btn-success { background-color: #10B981; color: white; } 
        .btn-success:hover { background-color: #059669; }
        .btn-info { background-color: #3B82F6; color: white; } 
        .btn-info:hover { background-color: #2563EB; }

        .hidden { display: none; }
        .notification-dot {
            height: 10px;
            width: 10px;
            background-color: #EF4444; 
            border-radius: 50%;
            position: absolute;
            top: -2px;
            right: -2px;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="main-header text-white p-6 shadow-lg">
        <h1 class="text-4xl font-bold text-center">Simulation Center KPH ü©∫‚ú®</h1>
    </header>

    <nav class="bg-white p-4 shadow-md flex justify-center space-x-2 md:space-x-4 sticky top-0 z-50">
        <button id="nav-mannequins" class="nav-button py-2 px-4 rounded-lg active">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏∏‡πà‡∏ô üß∏</button>
        <button id="nav-reservations" class="nav-button py-2 px-4 rounded-lg relative">
            ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á üìÖ
            <span id="reservation-notification-dot" class="notification-dot hidden"></span>
        </button>
        <button id="nav-admin" class="nav-button py-2 px-4 rounded-lg">‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà üîë</button>
    </nav>

    <main class="p-4 md:p-8">
        <section id="mannequins-view">
            <h2 class="text-3xl font-semibold mb-6 text-purple-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏∏‡πà‡∏ô‡∏ù‡∏∂‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div id="mannequin-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
        </section>

        <section id="reservations-view" class="hidden">
            <h2 class="text-3xl font-semibold mb-6 text-pink-600">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <div id="reservation-list" class="space-y-4">
                </div>
        </section>

        <section id="admin-login-view" class="hidden">
            <div class="max-w-md mx-auto mt-10 p-8 bg-white rounded-xl shadow-2xl">
                <h2 class="text-3xl font-semibold mb-8 text-center text-purple-700">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà üîë</h2>
                <form id="admin-login-form">
                    <div class="mb-6">
                        <label for="username" class="block text-lg font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
                        <input type="text" id="username" class="form-input" value="">
                    </div>
                    <div class="mb-8">
                        <label for="password" class="block text-lg font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
                        <input type="password" id="password" class="form-input" value="">
                    </div>
                    <button type="submit" class="btn btn-primary w-full text-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>
            </div>
        </section>

        <section id="admin-dashboard-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-semibold text-purple-700">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà üõ†Ô∏è</h2>
                <button id="admin-logout-button" class="btn btn-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>

            <nav class="bg-purple-100 p-3 mb-6 shadow-md flex justify-start space-x-2 md:space-x-4 rounded-lg">
                <button id="admin-nav-manage-mannequins" class="admin-nav-button py-2 px-4 rounded-lg active">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏∏‡πà‡∏ô‡∏ù‡∏∂‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞ üß∏</button>
                <button id="admin-nav-manage-reservations" class="admin-nav-button py-2 px-4 rounded-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á üìÖ</button>
            </nav>
            
            <div id="admin-manage-mannequins-section">
                <div class="mb-10 p-6 bg-white rounded-xl shadow-lg">
                    <h3 class="text-2xl font-semibold mb-4 text-pink-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏∏‡πà‡∏ô‡∏ù‡∏∂‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞</h3>
                    <form id="add-mannequin-form" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="mannequin-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πà‡∏ô:</label>
                            <input type="text" id="mannequin-name" class="form-input mt-1" required>
                        </div>
                        <div>
                            <label for="mannequin-image-url" class="block text-sm font-medium text-gray-700">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏∏‡πà‡∏ô:</label>
                            <input type="url" id="mannequin-image-url" class="form-input mt-1" placeholder="https://placehold.co/300x200">
                        </div>
                        <button type="submit" class="btn btn-primary md:self-end h-12">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà ‚ú®</button>
                    </form>
                    <div id="admin-mannequin-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="admin-manage-reservations-section" class="hidden">
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h3 class="text-2xl font-semibold mb-4 text-blue-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                    <div id="admin-reservation-list" class="space-y-3"></div>
                </div>
            </div>
        </section>
    </main>

    <div id="reservation-modal" class="fixed inset-0 modal items-center justify-center hidden z-50">
        <div class="modal-content">
            <h3 class="text-2xl font-semibold mb-6 text-purple-700">‡∏à‡∏≠‡∏á‡∏´‡∏∏‡πà‡∏ô <span id="modal-mannequin-name" class="text-pink-500"></span> üíñ</h3>
            <form id="reservation-form">
                <input type="hidden" id="modal-mannequin-id">
                <div class="mb-4">
                    <label for="user-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</label>
                    <input type="text" id="user-name" class="form-input mt-1" required>
                </div>
                <div class="mb-4">
                    <label for="user-phone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
                    <input type="tel" id="user-phone" class="form-input mt-1" required>
                </div>
                <div class="mb-4">
                    <label for="borrow-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á):</label>
                    <input type="date" id="borrow-date" class="form-input mt-1" required>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-reservation-button" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-borrow-modal" class="fixed inset-0 modal items-center justify-center hidden z-50">
        <div class="modal-content">
            <h3 class="text-2xl font-semibold mb-6 text-purple-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏´‡∏∏‡πà‡∏ô <span id="admin-borrow-modal-mannequin-name" class="text-pink-500"></span></h3>
            <form id="admin-borrow-form">
                <input type="hidden" id="admin-borrow-reservation-id">
                <input type="hidden" id="admin-borrow-mannequin-id">
                <div class="mb-4">
                    <label for="admin-lender-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏° (‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà):</label>
                    <input type="text" id="admin-lender-name" class="form-input mt-1" required>
                </div>
                <div class="mb-4">
                    <label for="admin-actual-borrow-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏à‡∏£‡∏¥‡∏á:</label>
                    <input type="date" id="admin-actual-borrow-date" class="form-input mt-1" required>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="admin-cancel-borrow-button" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-success">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-return-modal" class="fixed inset-0 modal items-center justify-center hidden z-50">
        <div class="modal-content">
            <h3 class="text-2xl font-semibold mb-6 text-purple-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏´‡∏∏‡πà‡∏ô <span id="admin-return-modal-mannequin-name" class="text-pink-500"></span></h3>
            <form id="admin-return-form">
                <input type="hidden" id="admin-return-reservation-id">
                <input type="hidden" id="admin-return-mannequin-id">
                <div class="mb-4">
                    <label for="admin-returner-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô:</label>
                    <input type="text" id="admin-returner-name" class="form-input mt-1" required>
                </div>
                <div class="mb-4">
                    <label for="admin-receiver-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô (‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà):</label>
                    <input type="text" id="admin-receiver-name" class="form-input mt-1" required>
                </div>
                <div class="mb-4">
                    <label for="admin-actual-return-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á:</label>
                    <input type="date" id="admin-actual-return-date" class="form-input mt-1" required>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="admin-cancel-return-button" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-success">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</button>
                </div>
            </form>
        </div>
    </div>
    
    <footer class="text-center p-6 mt-10 bg-gray-100 border-t border-gray-300">
        <p>&copy; 2025 Simulation Center KPH. All rights reserved. üè•</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBH2_W1jhPhbSZwhUuq3_GBv9jZpyVle3A",
            authDomain: "simulation-2025.firebaseapp.com",
            databaseURL: "https://simulation-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "simulation-2025",
            storageBucket: "simulation-2025.firebasestorage.app", 
            messagingSenderId: "99045127928",
            appId: "1:99045127928:web:17338b1eeeb469e8766d0d"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const mannequinListDiv = document.getElementById('mannequin-list');
        const reservationListDiv = document.getElementById('reservation-list'); 
        const adminMannequinListDiv = document.getElementById('admin-mannequin-list');
        const adminReservationListDiv = document.getElementById('admin-reservation-list'); 
        
        const reservationModal = document.getElementById('reservation-modal');
        const reservationForm = document.getElementById('reservation-form');
        const modalMannequinName = document.getElementById('modal-mannequin-name');
        const modalMannequinIdInput = document.getElementById('modal-mannequin-id');
        const cancelReservationButton = document.getElementById('cancel-reservation-button');
        
        const adminLoginForm = document.getElementById('admin-login-form');
        const usernameInput = document.getElementById('username'); 
        const passwordInput = document.getElementById('password'); 
        const addMannequinForm = document.getElementById('add-mannequin-form');
        const adminLogoutButton = document.getElementById('admin-logout-button');
        const reservationNotificationDot = document.getElementById('reservation-notification-dot');

        const adminBorrowModal = document.getElementById('admin-borrow-modal');
        const adminBorrowForm = document.getElementById('admin-borrow-form');
        const adminBorrowModalMannequinName = document.getElementById('admin-borrow-modal-mannequin-name');
        const adminBorrowReservationIdInput = document.getElementById('admin-borrow-reservation-id');
        const adminBorrowMannequinIdInput = document.getElementById('admin-borrow-mannequin-id');
        const adminCancelBorrowButton = document.getElementById('admin-cancel-borrow-button');
        const adminLenderNameInput = document.getElementById('admin-lender-name');
        const adminActualBorrowDateInput = document.getElementById('admin-actual-borrow-date');

        const adminReturnModal = document.getElementById('admin-return-modal');
        const adminReturnForm = document.getElementById('admin-return-form');
        const adminReturnModalMannequinName = document.getElementById('admin-return-modal-mannequin-name');
        const adminReturnReservationIdInput = document.getElementById('admin-return-reservation-id');
        const adminReturnMannequinIdInput = document.getElementById('admin-return-mannequin-id');
        const adminCancelReturnButton = document.getElementById('admin-cancel-return-button');
        const adminReturnerNameInput = document.getElementById('admin-returner-name');
        const adminReceiverNameInput = document.getElementById('admin-receiver-name');
        const adminActualReturnDateInput = document.getElementById('admin-actual-return-date');

        // Admin sub-navigation elements
        const adminNavManageMannequins = document.getElementById('admin-nav-manage-mannequins');
        const adminNavManageReservations = document.getElementById('admin-nav-manage-reservations');
        const adminManageMannequinsSection = document.getElementById('admin-manage-mannequins-section');
        const adminManageReservationsSection = document.getElementById('admin-manage-reservations-section');


        const views = {
            mannequins: document.getElementById('mannequins-view'),
            reservations: document.getElementById('reservations-view'),
            adminLogin: document.getElementById('admin-login-view'),
            adminDashboard: document.getElementById('admin-dashboard-view'),
        };
        const navButtons = {
            mannequins: document.getElementById('nav-mannequins'),
            reservations: document.getElementById('nav-reservations'),
            admin: document.getElementById('nav-admin'),
        };

        let currentView = 'mannequins';
        let currentAdminSubView = 'manageMannequins'; // Default admin sub-view
        let isAdminLoggedIn = false; 
        let autoLogoutTimer = null; 

        function showAdminSubView(subViewName) {
            adminManageMannequinsSection.classList.add('hidden');
            adminManageReservationsSection.classList.add('hidden');
            adminNavManageMannequins.classList.remove('active');
            adminNavManageReservations.classList.remove('active');

            if (subViewName === 'manageMannequins') {
                adminManageMannequinsSection.classList.remove('hidden');
                adminNavManageMannequins.classList.add('active');
            } else if (subViewName === 'manageReservations') {
                adminManageReservationsSection.classList.remove('hidden');
                adminNavManageReservations.classList.add('active');
            }
            currentAdminSubView = subViewName;
        }

        adminNavManageMannequins.addEventListener('click', () => showAdminSubView('manageMannequins'));
        adminNavManageReservations.addEventListener('click', () => showAdminSubView('manageReservations'));


        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            
            Object.values(navButtons).forEach(btn => btn.classList.remove('active'));
            if (navButtons[viewName]) {
                 navButtons[viewName].classList.add('active');
            } else if (viewName === 'adminDashboard' || viewName === 'adminLogin') { 
                 navButtons.admin.classList.add('active');
            }
            currentView = viewName;

            if (viewName === 'adminDashboard') {
                showAdminSubView(currentAdminSubView); // Show the last active or default admin sub-view
            }

            if (viewName === 'reservations') { 
                reservationNotificationDot.classList.add('hidden');
            }
        }

        navButtons.mannequins.addEventListener('click', () => showView('mannequins'));
        navButtons.reservations.addEventListener('click', () => showView('reservations'));
        navButtons.admin.addEventListener('click', () => {
            if (isAdminLoggedIn) {
                showView('adminDashboard');
            } else {
                showView('adminLogin');
            }
        });
        
        function getTodayDateString() {
            return new Date().toISOString().split("T")[0];
        }
        document.getElementById('borrow-date').min = getTodayDateString();
        adminActualBorrowDateInput.value = getTodayDateString(); 
        adminActualReturnDateInput.value = getTodayDateString();

        function getStatusDisplay(status) {
            switch (status) {
                case '‡∏ß‡πà‡∏≤‡∏á': return '<span class="status-badge status-available">‡∏ß‡πà‡∏≤‡∏á</span>';
                case '‡∏à‡∏≠‡∏á': return '<span class="status-badge status-reserved">‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>';
                case '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°': return '<span class="status-badge status-borrowed">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</span>';
                case '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥': return '<span class="status-badge status-pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
                case '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß': return '<span class="status-badge status-approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>';
                case '‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡πâ‡∏ß': return '<span class="status-badge status-borrowed">‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>';
                case '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß': return '<span class="status-badge status-returned">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
                case '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ': return '<span class="status-badge status-cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>';
                case '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà': return `<span class="status-badge status-cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ ‡∏à‡∏ô‡∏ó.</span>`;
                case '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á': return `<span class="status-badge status-maintenance">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</span>`;
                default: return `<span class="status-badge" style="background-color: #6B7280; color: white;">${status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>`;
            }
        }

        function formatDate(dateInput) { 
            if (!dateInput) return 'N/A';
            const date = (typeof dateInput === 'number') ? new Date(dateInput) : new Date(dateInput + 'T00:00:00Z'); 
            if (isNaN(date.getTime())) return 'Invalid Date';
             return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        function calculateReturnDate(borrowDateStr) {
            if (!borrowDateStr) return null;
            const borrowDate = new Date(borrowDateStr + 'T00:00:00Z'); 
            if (isNaN(borrowDate.getTime())) return null;
            borrowDate.setDate(borrowDate.getDate() + 7);
            return borrowDate.toISOString().split("T")[0];
        }

        onValue(ref(database, 'mannequins'), (snapshot) => {
            const mannequins = snapshot.val();
            if (!mannequinListDiv) return;
            mannequinListDiv.innerHTML = ''; 
            if (mannequins) {
                Object.entries(mannequins).forEach(([id, mannequin]) => {
                    if (!mannequin) return;
                    const card = document.createElement('div');
                    card.className = 'card p-5 flex flex-col items-center text-center space-y-3';
                    const imageUrl = mannequin.imageUrl || 'https://placehold.co/300x200/E0BBE4/333333?text=Mannequin&font=sarabun';
                    card.innerHTML = `
                        <img src="${imageUrl}" alt="${mannequin.name}" class="w-full h-48 object-cover rounded-lg mb-3" onerror="this.src='https://placehold.co/300x200/D1D5DB/1F2937?text=‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢&font=sarabun'">
                        <h3 class="text-xl font-semibold text-purple-600">${mannequin.name}</h3>
                        <div class="text-lg">${getStatusDisplay(mannequin.status)}</div>
                        ${mannequin.status === '‡∏ß‡πà‡∏≤‡∏á' ? `<button data-id="${id}" data-name="${mannequin.name}" class="btn btn-secondary reserve-button w-full">‡∏à‡∏≠‡∏á‡∏´‡∏∏‡πà‡∏ô‡∏ô‡∏µ‡πâ üíñ</button>` : ''}
                    `;
                    mannequinListDiv.appendChild(card);
                });
                document.querySelectorAll('.reserve-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        modalMannequinIdInput.value = e.target.dataset.id;
                        modalMannequinName.textContent = e.target.dataset.name;
                        reservationModal.classList.remove('hidden');
                        reservationModal.classList.add('flex');
                        document.getElementById('borrow-date').value = getTodayDateString(); 
                    });
                });
            } else {
                mannequinListDiv.innerHTML = '<p class="text-gray-500 col-span-full text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏∏‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö üôÅ</p>';
            }
        });

        cancelReservationButton.addEventListener('click', () => {
            reservationModal.classList.add('hidden');
            reservationModal.classList.remove('flex');
            reservationForm.reset();
        });

        reservationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const mannequinId = modalMannequinIdInput.value;
            const mannequinName = modalMannequinName.textContent;
            const userName = document.getElementById('user-name').value;
            const userPhone = document.getElementById('user-phone').value;
            const requestedBorrowDate = document.getElementById('borrow-date').value;

            const reservationData = {
                mannequinId,
                mannequinName,
                userName,
                userPhone,
                requestedBorrowDate, 
                reservationTimestamp: serverTimestamp(), 
                status: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' 
            };

            const newReservationRef = push(ref(database, 'reservations'));
            set(newReservationRef, reservationData)
                .then(() => update(ref(database, `mannequins/${mannequinId}`), { status: '‡∏à‡∏≠‡∏á' }))
                .then(() => {
                    alert('‡∏à‡∏≠‡∏á‡∏´‡∏∏‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞! üéâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
                    reservationModal.classList.add('hidden');
                    reservationModal.classList.remove('flex');
                    reservationForm.reset();
                    if (currentView !== 'reservations' && currentView !== 'adminDashboard') { 
                        reservationNotificationDot.classList.remove('hidden');
                    }
                    showView('reservations'); 
                })
                .catch(error => {
                    console.error("Error making reservation: ", error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ' + error.message);
                });
        });

        onValue(ref(database, 'reservations'), (snapshot) => {
            const reservations = snapshot.val() || {};
            if (!reservationListDiv) return;
            reservationListDiv.innerHTML = ''; 

            const userVisibleReservations = Object.entries(reservations)
                .filter(([id, res]) => res.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' || res.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß')
                .sort(([,a], [,b]) => (b.reservationTimestamp || 0) - (a.reservationTimestamp || 0)); 

            if (userVisibleReservations.length > 0) {
                userVisibleReservations.forEach(([id, reservation]) => {
                    const item = document.createElement('div');
                    item.className = 'card p-4 flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-lg text-pink-600">${reservation.mannequinName}</p>
                            <p class="text-sm text-gray-600">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${reservation.userName} (‡πÇ‡∏ó‡∏£: ${reservation.userPhone})</p>
                            <p class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏∑‡∏°: ${formatDate(reservation.requestedBorrowDate)}</p>
                            <p class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á: ${formatDate(reservation.reservationTimestamp)}</p>
                        </div>
                        ${getStatusDisplay(reservation.status)}
                    `;
                    reservationListDiv.appendChild(item);
                });
            } else {
                 reservationListDiv.innerHTML = '<p class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ü§∑‚Äç‚ôÄÔ∏è</p>';
            }
            
            const hasPendingForUserNotification = Object.values(reservations).some(res => res.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
            if (hasPendingForUserNotification && currentView !== 'reservations' && currentView !== 'adminDashboard' && currentView !== 'adminLogin') {
                reservationNotificationDot.classList.remove('hidden');
            } else {
                reservationNotificationDot.classList.add('hidden');
            }
        });

        function handleAdminLogout(isAutoLogout = false) {
            isAdminLoggedIn = false;
            if (autoLogoutTimer) {
                clearTimeout(autoLogoutTimer);
                autoLogoutTimer = null;
            }
            navButtons.admin.textContent = '‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà üîë'; 
            usernameInput.value = ''; 
            passwordInput.value = ''; 
            showView('mannequins'); 
            if (isAutoLogout) {
                alert("‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            }
        }

        function startAutoLogoutTimer() {
            if (autoLogoutTimer) {
                clearTimeout(autoLogoutTimer);
            }
            autoLogoutTimer = setTimeout(() => {
                if (isAdminLoggedIn) { 
                    console.log("Auto-logging out admin due to session timeout.");
                    handleAdminLogout(true);
                }
            }, 3600000); 
        }


        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentUsername = usernameInput.value; 
            const currentPassword = passwordInput.value; 

            const validCredentials = [
                { user: 'sck2025', pass: '2025' },
                { user: 'admin', pass: '1111' },
                { user: 'nongmai', pass: '1111' }
            ];

            const foundUser = validCredentials.find(cred => cred.user === currentUsername && cred.pass === currentPassword);

            if (foundUser) {
                isAdminLoggedIn = true;
                showView('adminDashboard');
                navButtons.admin.textContent = `‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (${currentUsername})`; 
                startAutoLogoutTimer(); 
            } else {
                alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á üôÅ');
            }
        });
        
        adminLogoutButton.addEventListener('click', () => {
            handleAdminLogout(false); 
        });

        addMannequinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('mannequin-name').value;
            const imageUrlInput = document.getElementById('mannequin-image-url').value;
            let imageUrl = imageUrlInput || 'https://placehold.co/300x200/C3B1E1/FFFFFF?text=Mannequin&font=sarabun'; 

            set(push(ref(database, 'mannequins')), { name, imageUrl, status: '‡∏ß‡πà‡∏≤‡∏á' })
                .then(() => { 
                    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); 
                    addMannequinForm.reset(); 
                })
                .catch(error => alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πà‡∏ô: ' + error.message));
        });

        onValue(ref(database, 'mannequins'), (snapshot) => {
            const mannequins = snapshot.val();
            if (!adminMannequinListDiv) return;
            adminMannequinListDiv.innerHTML = '';
            if (mannequins) {
                Object.entries(mannequins).forEach(([id, mannequin]) => {
                    if (!mannequin) return;
                    const item = document.createElement('div');
                    item.className = 'card p-3 flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0';
                    item.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="${mannequin.imageUrl || 'https://placehold.co/60x40/E0BBE4/333333?text=Img&font=sarabun'}" alt="${mannequin.name}" class="w-16 h-10 object-cover rounded" onerror="this.src='https://placehold.co/60x40/D1D5DB/1F2937?text=Error&font=sarabun'">
                            <span class="font-medium">${mannequin.name}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <select data-id="${id}" class="admin-mannequin-status-select form-input py-1 px-2 text-sm w-36">
                                <option value="‡∏ß‡πà‡∏≤‡∏á" ${mannequin.status === '‡∏ß‡πà‡∏≤‡∏á' ? 'selected' : ''}>‡∏ß‡πà‡∏≤‡∏á</option>
                                <option value="‡∏à‡∏≠‡∏á" ${mannequin.status === '‡∏à‡∏≠‡∏á' ? 'selected' : ''}>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
                                <option value="‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°" ${mannequin.status === '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°' ? 'selected' : ''}>‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</option>
                                <option value="‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" ${mannequin.status === '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' ? 'selected' : ''}>‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option>
                            </select>
                            </div>
                    `;
                    adminMannequinListDiv.appendChild(item);
                });
                
                document.querySelectorAll('.admin-mannequin-status-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        update(ref(database, `mannequins/${e.target.dataset.id}`), { status: e.target.value })
                            .then(() => alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏∏‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'))
                            .catch(err => alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message));
                    });
                });
            } else {
                adminMannequinListDiv.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏∏‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
            }
        });
        
        adminCancelBorrowButton.addEventListener('click', () => {
            adminBorrowModal.classList.add('hidden');
            adminBorrowModal.classList.remove('flex');
            adminBorrowForm.reset();
        });

        adminBorrowForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const reservationId = adminBorrowReservationIdInput.value;
            const mannequinId = adminBorrowMannequinIdInput.value;
            const lenderName = adminLenderNameInput.value;
            const actualBorrowDate = adminActualBorrowDateInput.value;

            const updates = {};
            updates[`reservations/${reservationId}/status`] = '‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡πâ‡∏ß';
            updates[`reservations/${reservationId}/lenderName`] = lenderName;
            updates[`reservations/${reservationId}/actualBorrowDate`] = actualBorrowDate;
            updates[`mannequins/${mannequinId}/status`] = '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°';

            update(ref(database), updates)
                .then(() => {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    adminBorrowModal.classList.add('hidden');
                    adminBorrowModal.classList.remove('flex');
                    adminBorrowForm.reset();
                })
                .catch(err => alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°: ' + err.message));
        });

        adminCancelReturnButton.addEventListener('click', () => {
            adminReturnModal.classList.add('hidden');
            adminReturnModal.classList.remove('flex');
            adminReturnForm.reset();
        });

        adminReturnForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const reservationId = adminReturnReservationIdInput.value;
            const mannequinId = adminReturnMannequinIdInput.value;
            const returnerName = adminReturnerNameInput.value;
            const receiverName = adminReceiverNameInput.value;
            const actualReturnDate = adminActualReturnDateInput.value;

            const updates = {};
            updates[`reservations/${reservationId}/status`] = '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
            updates[`reservations/${reservationId}/returnerName`] = returnerName;
            updates[`reservations/${reservationId}/receiverName`] = receiverName;
            updates[`reservations/${reservationId}/actualReturnDate`] = actualReturnDate;
            updates[`mannequins/${mannequinId}/status`] = '‡∏ß‡πà‡∏≤‡∏á'; 

            update(ref(database), updates)
                .then(() => {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏´‡∏∏‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    adminReturnModal.classList.add('hidden');
                    adminReturnModal.classList.remove('flex');
                    adminReturnForm.reset();
                })
                .catch(err => alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô: ' + err.message));
        });


        onValue(ref(database, 'reservations'), (snapshot) => {
            const reservations = snapshot.val() || {};
            if (!adminReservationListDiv) return;
            adminReservationListDiv.innerHTML = '';

            const sortedReservations = Object.entries(reservations)
                .sort(([,a], [,b]) => (b.reservationTimestamp || 0) - (a.reservationTimestamp || 0)); 

            if (sortedReservations.length > 0) {
                sortedReservations.forEach(([id, res]) => {
                    const item = document.createElement('div');
                    item.className = 'card p-4 space-y-2';
                    
                    let actionsHtml = '';
                    if (res.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') {
                        actionsHtml += `<button data-id="${id}" class="btn btn-success btn-sm approve-reservation-button">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button> `;
                    }
                    if (res.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß') { 
                         actionsHtml += `<button data-id="${id}" data-mannequin-id="${res.mannequinId}" data-mannequin-name="${res.mannequinName}" class="btn btn-info btn-sm open-mark-borrowed-modal-button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button> `;
                    }
                    if (res.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' || res.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß') {
                         actionsHtml += `<button data-id="${id}" data-mannequin-id="${res.mannequinId}" class="btn btn-danger btn-sm cancel-admin-reservation-button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á</button>`;
                    }

                    if (res.status === '‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡πâ‡∏ß') {
                        actionsHtml += `<button data-id="${id}" data-mannequin-id="${res.mannequinId}" data-mannequin-name="${res.mannequinName}" class="btn btn-primary btn-sm open-mark-returned-modal-button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</button>`;
                    }

                    let detailsHtml = '';
                    if (res.status === '‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡πâ‡∏ß') {
                        detailsHtml += `<p class="text-xs text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°: ${res.lenderName || 'N/A'}</p>`;
                        detailsHtml += `<p class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏à‡∏£‡∏¥‡∏á: ${formatDate(res.actualBorrowDate) || 'N/A'}</p>`;
                        const dueDate = calculateReturnDate(res.actualBorrowDate);
                        if (dueDate) {
                             detailsHtml += `<p class="text-xs font-semibold text-red-500">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(dueDate)}</p>`;
                        }
                    }
                     if (res.status === '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß') {
                        detailsHtml += `<p class="text-xs text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°: ${res.lenderName || 'N/A'}</p>`;
                        detailsHtml += `<p class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏à‡∏£‡∏¥‡∏á: ${formatDate(res.actualBorrowDate) || 'N/A'}</p>`;
                        detailsHtml += `<p class="text-xs text-gray-600">‡∏ú‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô: ${res.returnerName || 'N/A'}</p>`;
                        detailsHtml += `<p class="text-xs text-gray-600">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô: ${res.receiverName || 'N/A'}</p>`;
                        detailsHtml += `<p class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á: ${formatDate(res.actualReturnDate) || 'N/A'}</p>`;
                    }
                    
                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <p class="font-semibold text-md text-blue-700">${res.mannequinName || 'N/A'}</p>
                            ${getStatusDisplay(res.status)}
                        </div>
                        <p class="text-xs text-gray-600">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${res.userName || 'N/A'} (‡πÇ‡∏ó‡∏£: ${res.userPhone || 'N/A'})</p>
                        <p class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏∑‡∏°: ${formatDate(res.requestedBorrowDate)}</p>
                        <p class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á: ${formatDate(res.reservationTimestamp)}</p>
                        ${detailsHtml}
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${actionsHtml}
                        </div>
                    `;
                    adminReservationListDiv.appendChild(item);
                });

                document.querySelectorAll('.approve-reservation-button').forEach(btn => btn.addEventListener('click', e => {
                    update(ref(database, `reservations/${e.target.dataset.id}`), { status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' })
                        .then(() => alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'))
                        .catch(err => alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message));
                }));

                document.querySelectorAll('.open-mark-borrowed-modal-button').forEach(btn => btn.addEventListener('click', e => {
                    adminBorrowReservationIdInput.value = e.target.dataset.id;
                    adminBorrowMannequinIdInput.value = e.target.dataset.mannequinId;
                    adminBorrowModalMannequinName.textContent = e.target.dataset.mannequinName;
                    adminActualBorrowDateInput.value = getTodayDateString(); 
                    adminLenderNameInput.value = ''; 
                    adminBorrowModal.classList.remove('hidden');
                    adminBorrowModal.classList.add('flex');
                }));
                
                document.querySelectorAll('.open-mark-returned-modal-button').forEach(btn => btn.addEventListener('click', e => {
                    adminReturnReservationIdInput.value = e.target.dataset.id;
                    adminReturnMannequinIdInput.value = e.target.dataset.mannequinId;
                    adminReturnModalMannequinName.textContent = e.target.dataset.mannequinName;
                    adminActualReturnDateInput.value = getTodayDateString();
                    adminReturnerNameInput.value = '';
                    adminReceiverNameInput.value = '';
                    adminReturnModal.classList.remove('hidden');
                    adminReturnModal.classList.add('flex');
                }));

                document.querySelectorAll('.cancel-admin-reservation-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const reservationId = e.target.dataset.id;
                        const mannequinId = e.target.dataset.mannequinId;
                        console.log(`[Cancel Reservation] Clicked: ResID=${reservationId}, MannequinID=${mannequinId}`); 
                        
                        if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                            console.log(`[Cancel Reservation] Confirmed: ResID=${reservationId}`); 
                            const mannequinRef = ref(database, `mannequins/${mannequinId}`);
                            const reservationToRemoveRef = ref(database, `reservations/${reservationId}`);
                            
                            remove(reservationToRemoveRef)
                                .then(() => {
                                    console.log(`[Cancel Reservation] Successfully removed ResID: ${reservationId}. Checking mannequin status.`); 
                                    onValue(ref(database, 'reservations'), (allReservationsSnapshot) => {
                                        const allReservations = allReservationsSnapshot.val() || {};
                                        const hasOtherActiveReservations = Object.values(allReservations)
                                            .some(resData => 
                                                resData.mannequinId === mannequinId &&
                                                (resData.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' || resData.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß')
                                            );
                                        
                                        if (!hasOtherActiveReservations) {
                                            onValue(mannequinRef, (mannequinSnapshot) => {
                                                const mannequinData = mannequinSnapshot.val();
                                                if (mannequinData && mannequinData.status === '‡∏à‡∏≠‡∏á') { 
                                                    console.log(`[Cancel Reservation] Mannequin ${mannequinId} has no other active reservations and was '‡∏à‡∏≠‡∏á'. Setting to '‡∏ß‡πà‡∏≤‡∏á'.`);
                                                    update(mannequinRef, { status: '‡∏ß‡πà‡∏≤‡∏á' });
                                                } else {
                                                    console.log(`[Cancel Reservation] Mannequin ${mannequinId} status not changed to '‡∏ß‡πà‡∏≤‡∏á'. Current status: ${mannequinData ? mannequinData.status : 'N/A'}`);
                                                }
                                            }, { onlyOnce: true }); 
                                        } else {
                                            console.log(`[Cancel Reservation] Mannequin ${mannequinId} still has other active reservations. Status not changed to '‡∏ß‡πà‡∏≤‡∏á'.`);
                                        }
                                        alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                                    }, { onlyOnce: true }); 
                                })
                                .catch(err => {
                                    console.error(`[Cancel Reservation] Error ResID ${reservationId}:`, err); 
                                    alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ' + err.message);
                                });
                        } else {
                            console.log(`[Cancel Reservation] Cancelled by user for ResID: ${reservationId}`); 
                        }
                    });
                });

            } else {
                adminReservationListDiv.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>';
            }
        });

        showView('mannequins'); // Initial view
        showAdminSubView('manageMannequins'); // Default admin sub-view on load (if admin view is shown)
    </script>
</body>
</html>